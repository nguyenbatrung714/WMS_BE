<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.example.wms_be.mapper.account.UserMapper">

    <resultMap id="UserMap" type="org.example.wms_be.entity.account.User" autoMapping="true">
        <id property="sysIdUser" column="sys_id_user"/>
        <result property="username" column="username"/>
        <result property="password" column="password"/>
        <result property="email" column="email"/>
        <result property="fullName" column="full_name"/>
        <result property="soDienThoai" column="so_dien_thoai"/>

        <collection property="roles" ofType="Role">
            <id property="sysIdRole" column="sys_id_role"/>
            <result property="roleName" column="role_name"/>
            <result property="moTa" column="mo_ta"/>
        </collection>
    </resultMap>
    <update id="updateInfo">
        UPDATE user
        SET full_name = #{fullName}, email = #{email}, so_dien_thoai = #{soDienThoai}
        WHERE username = #{username};
    </update>
    <update id="updateMatKhau">
        UPDATE user
        SET password=#{password}
        WHERE username = #{username};
    </update>

    <select id="findUserByUsername" parameterType="String" resultMap="UserMap">
        select *
        from user u
                 left join users_roles ur on u.sys_id_user = ur.sys_id_user
                 left join role r on ur.sys_id_role = r.sys_id_role
        where u.username = #{username};
    </select>

    <!-- check exits-->
    <select id="checkUserExits" resultType="boolean" parameterType="integer">
        SELECT EXISTS(SELECT 1 FROM user WHERE sys_id_user = #{sysIdUser});
    </select>
    <select id="getEmailByRoles" parameterType="String" resultType="HashMap">
        SELECT u.full_name AS fullName,
               r.mo_ta AS role
        FROM user u
                 JOIN users_roles ur ON u.sys_id_user = ur.sys_id_user
                 JOIN role r ON ur.sys_id_role = r.sys_id_role
        WHERE u.email = #{email} AND (r.role_name = 'admin' OR r.role_name = 'manager');
    </select>
    <select id="getFullNameByRoles" resultType="java.lang.String">
        SELECT u.full_name
        FROM user u
                 JOIN users_roles ur ON u.sys_id_user = ur.sys_id_user
                 JOIN role r ON ur.sys_id_role = r.sys_id_role
        WHERE r.sys_id_role = #{sysIdRole};
    </select>
    <select id="checkMailExits" resultType="boolean" parameterType="String">
    SELECT EXISTS(SELECT 1
    FROM user u
    JOIN users_roles ur ON u.sys_id_user = ur.sys_id_user
    JOIN role r ON ur.sys_id_role = r.sys_id_role
    WHERE u.email = #{email} AND (r.role_name = 'admin' OR r.role_name = 'manager'));
    </select>
    <select id="checkUserExitsByUserName">
        SELECT EXISTS(SELECT 1 FROM user WHERE username = #{username})

    </select>
    <select id="findUserById" resultType="org.example.wms_be.entity.account.User">
        select *
        from user u
                 left join users_roles ur on u.sys_id_user = ur.sys_id_user
                 left join role r on ur.sys_id_role = r.sys_id_role
        WHERE u.sys_id_user = #{sysIdUser}
    </select>
    <select id="findAll" resultMap="UserMap">
        select *
        from user u
                 left join users_roles ur on u.sys_id_user = ur.sys_id_user
                 left join role r on ur.sys_id_role = r.sys_id_role
    </select>

</mapper>